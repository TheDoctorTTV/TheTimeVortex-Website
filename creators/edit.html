<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Creator Page</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="/js/header-footer.js"></script>
  <script src="/js/darkmode.js" defer></script>
  <script src="/public/auth.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Kodchasan:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
    rel="stylesheet">
  <script>
    (function () {
      const dm = localStorage.getItem('darkmode');
      const sys = matchMedia('(prefers-color-scheme: dark)').matches;
      if (dm === 'dark' || (dm === 'system' && sys)) {
        document.documentElement.classList.add('darkmode');
      }
    })();
  </script>
</head>
<body>
  <global-header></global-header>
  <div class="main-container">
    <div class="main">
      <h1>Edit Your Page</h1>
      <div class="form-section">
        <label for="about-input">About Me (Markdown supported)</label>
        <textarea id="about-input" class="text-input full-width textarea-lg"></textarea>
      </div>
      <div class="form-section">
        <label for="discord-text-input">Discord Section Text (Markdown supported)</label>
        <textarea id="discord-text-input" class="text-input full-width textarea-lg"></textarea>
      </div>
      <div class="form-section">
        <label for="discord-invite-input">Discord Invite Link</label>
        <input id="discord-invite-input" class="text-input full-width" type="text" />
      </div>
      <div class="form-section">
        <label for="avatar-input">Profile Picture URL (optional)</label>
        <input id="avatar-input" class="text-input full-width" type="text" placeholder="Leave blank to use Discord avatar" />
      </div>
      <div class="form-section">
        <h2>Social Links</h2>
        <div id="links-container"></div>
        <button class="invite" id="add-link" type="button">Add Link</button>
      </div>
      <div class="form-actions">
        <button class="invite" id="save-btn" type="button">Save Draft</button>
        <button class="invite" id="publish-btn" type="button">Publish</button>
        <button class="invite" id="delete-btn" type="button">Delete Page</button>
      </div>
      <p class="mt-1" id="status"></p>
    </div>
  </div>
  <global-footer></global-footer>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const aboutInput = document.getElementById('about-input');
      const discordTextInput = document.getElementById('discord-text-input');
      const discordInviteInput = document.getElementById('discord-invite-input');
      const avatarInput = document.getElementById('avatar-input');
      const linksContainer = document.getElementById('links-container');
      const status = document.getElementById('status');
      const params = new URLSearchParams(window.location.search);
      const slugParam = params.get('slug');
      let existing = {};
      let discordAvatar = '';

      function discordAvatarUrl(userId, avatarHash, size = 240) {
        if (userId && avatarHash) {
          const ext = avatarHash.startsWith('a_') ? 'gif' : 'png';
          return `https://cdn.discordapp.com/avatars/${userId}/${avatarHash}.${ext}?size=${size}`;
        }
        try {
          const idx = BigInt(userId ?? 0n) % 5n;
          return `https://cdn.discordapp.com/embed/avatars/${idx}.png`;
        } catch {
          return `https://cdn.discordapp.com/embed/avatars/0.png`;
        }
      }

      function sanitizeUrl(url) {
        try {
          const u = new URL(url, window.location.origin);
          if (u.protocol === 'https:' && u.origin === window.location.origin) return u.href;
          if (u.protocol === 'https:' && u.origin !== window.location.origin) return u.href;
        } catch {}
        return '';
      }

      function createLinkRow(link = {}) {
        const row = document.createElement('div');
        row.className = 'link-row';

        const labelInput = document.createElement('input');
        labelInput.type = 'text';
        labelInput.className = 'text-input link-label';
        labelInput.placeholder = 'Label';
        labelInput.value = link.label || '';
        row.appendChild(labelInput);

        const urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.className = 'text-input link-url';
        urlInput.placeholder = 'URL';
        urlInput.value = link.url || '';
        row.appendChild(urlInput);

        const iconLightInput = document.createElement('input');
        iconLightInput.type = 'text';
        iconLightInput.className = 'text-input link-icon-light';
        iconLightInput.placeholder = 'Icon (Light)';
        iconLightInput.value = link.icon_light || link.icon || '';
        row.appendChild(iconLightInput);

        const iconDarkInput = document.createElement('input');
        iconDarkInput.type = 'text';
        iconDarkInput.className = 'text-input link-icon-dark';
        iconDarkInput.placeholder = 'Icon (Dark)';
        iconDarkInput.value = link.icon_dark || '';
        row.appendChild(iconDarkInput);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'invite remove-link';
        removeBtn.type = 'button';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => row.remove());
        row.appendChild(removeBtn);

        linksContainer.appendChild(row);
      }

      document.getElementById('add-link').addEventListener('click', () => createLinkRow());

      try {
        const meUrl = slugParam ? `/creators/me?slug=${encodeURIComponent(slugParam)}` : '/creators/me';
        const res = await fetch(meUrl, { credentials: 'include', cache: 'no-store' });
        if (res.status === 401) {
          window.location.href = '/login';
          return;
        }
        if (!res.ok) {
          window.location.href = '/profile.html';
          return;
        }
        const info = await res.json();
        existing = info.data_json || {};
        discordAvatar = discordAvatarUrl(info.owner_user_id, info.owner_avatar);
        aboutInput.value = existing.about || '';
        discordTextInput.value = existing.discord_text || '';
        discordInviteInput.value = existing.discord_invite || '';
        avatarInput.value = existing.avatar_url || '';
        if (Array.isArray(existing.social_links)) {
          for (const l of existing.social_links) createLinkRow(l);
        }
      } catch (e) {
        window.location.href = '/profile.html';
      }

      async function submit(path) {
        const links = [];
        linksContainer.querySelectorAll('.link-row').forEach(row => {
          const label = row.querySelector('.link-label').value.trim();
          const url = sanitizeUrl(row.querySelector('.link-url').value.trim());
          const iconLight = row.querySelector('.link-icon-light').value.trim();
          const iconDark = row.querySelector('.link-icon-dark').value.trim();
          if (label && url) {
            const link = { label, url };
            if (iconLight && iconDark) {
              link.icon_light = iconLight;
              link.icon_dark = iconDark;
            } else if (iconLight) {
              link.icon = iconLight;
            } else if (iconDark) {
              link.icon = iconDark;
            }
            links.push(link);
          }
        });
          const payload = Object.assign({}, existing, {
            about: aboutInput.value.trim(),
            discord_text: discordTextInput.value.trim(),
            discord_invite: sanitizeUrl(discordInviteInput.value.trim()),
            avatar_url: avatarInput.value.trim() || discordAvatar,
            social_links: links
          });
        try {
          const url = slugParam ? `${path}?slug=${encodeURIComponent(slugParam)}` : path;
          const r = await fetch(url, {
            method: 'POST',
            credentials: 'include',
            cache: 'no-store',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(payload)
          });
          status.textContent = r.ok ? (path.endsWith('publish') ? 'Published!' : 'Draft saved.') : 'Failed to save.';
        } catch {
          status.textContent = 'Failed to save.';
        }
      }

      document.getElementById('save-btn').addEventListener('click', () => submit('/creators/save'));
      document.getElementById('publish-btn').addEventListener('click', () => submit('/creators/publish'));
      document.getElementById('delete-btn').addEventListener('click', async () => {
        if (!confirm('Delete this page?')) return;
        const url = slugParam ? `/creators/delete?slug=${encodeURIComponent(slugParam)}` : '/creators/delete';
        try {
          const r = await fetch(url, { method: 'POST', credentials: 'include', cache: 'no-store' });
          if (r.ok) {
            window.location.href = '/profile.html';
          } else {
            status.textContent = 'Failed to delete.';
          }
        } catch {
          status.textContent = 'Failed to delete.';
        }
      });
    });
  </script>
</body>
</html>
