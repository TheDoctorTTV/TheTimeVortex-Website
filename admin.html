<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TheTimeVortex â€” Admin</title>

  <!-- Styles & Icons -->
  <link rel="stylesheet" href="/style.css" />
  <link rel="shortcut icon" type="image/x-icon" href="/icons/WebsiteLogo.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/WebsiteLogo.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/WebsiteLogo.ico">

  <!-- OpenGraph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="TheTimeVortex â€” Admin" />
  <meta property="og:description" content="Site admin dashboard for TheTimeVortex." />
  <meta property="og:url" content="https://thetimevortex.net/admin.html" />
  <meta property="og:image" content="/icons/WebsiteLogo.ico" />

  <!-- Header/Footer & Theme -->
  <script src="/js/header-footer.js"></script>
  <script src="/js/darkmode.js" defer></script>
  <script src="/public/auth.js" defer></script>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kodchasan:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

  <!-- First-paint dark mode -->
  <script>
    (function () {
      const dm = localStorage.getItem('darkmode');
      const sys = matchMedia('(prefers-color-scheme: dark)').matches;
      if (dm === 'dark' || (dm === 'system' && sys)) {
        document.documentElement.classList.add('darkmode');
      }
    })();
  </script>

  <style>
    /* small helpers that match your site vibe */
    .row { display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; }
    .text-input {
      padding:.6rem .8rem; border-radius:12px; border:1px solid var(--border, #4442);
      background: var(--bg, transparent); color: inherit; font: inherit; min-width:260px;
    }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { padding:.6rem .5rem; border-bottom:1px solid #6663; text-align:left; }
    .pill { padding:.2rem .55rem; border-radius:999px; font-size:.8rem; opacity:.8; border:1px solid #6664; }
    .avatar { width:28px; height:28px; border-radius:50%; object-fit:cover; }
    .right { text-align:right; }
    .muted { opacity:.75; font-size:.9rem; }
    .card-panel { padding:1.25rem; border-radius:18px; box-shadow:0 8px 30px #0002; background:var(--card, rgba(255,255,255,.02)); }
  </style>
</head>

<body>
  <global-header></global-header>

  <div class="container">
    <div class="banner-container"></div>

    <!-- Admin Gate -->
    <div class="main" id="admin-gate" style="display:none">
      <h1>Admin Dashboard</h1>
      <p>Welcome, <span id="admin-name"></span> ðŸ‘‹</p>
      <p class="about-me">
        Manage site roles and features below.
      </p>
    </div>

    <!-- Not logged-in notice -->
    <div class="main" id="admin-login-needed" style="display:none">
      <h1>Admin Login Required</h1>
      <p class="about-me">You must be logged in with your Discord account to access admin tools.</p>
      <br/>
      <button class="invite" id="go-login">Login</button>
    </div>

    <!-- ============ ADMINS MANAGER ============ -->
    <div class="discord" id="admins-manager" style="display:none">
      <h1>Admins Manager</h1>
      <p class="muted">Add/remove Discord IDs with access to this dashboard.</p>
      <br>

      <div class="card-panel">
        <div class="row">
          <input id="new-admin-id" class="text-input" type="text" placeholder="Discord User ID (e.g., 123456789012345678)" />
          <button class="invite" id="btn-add-admin">Add Admin</button>
          <button class="invite" id="btn-remove-admin">Remove Admin</button>
        </div>
        <p class="muted" style="margin-top:.5rem">Tip: Right-click a user in Discord âžœ Copy ID (enable Developer Mode in Discord settings).</p>
      </div>

      <br><br>
      <div class="card-panel">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Current Admins</h2>
          <button class="invite" id="btn-refresh">Refresh</button>
        </div>
        <br>
        <div class="table-wrap">
          <table class="table" id="admins-table" aria-label="Admins table">
            <thead>
              <tr>
                <th>User</th>
                <th>Discord ID</th>
                <th>Added By</th>
                <th>Added At</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="admins-tbody">
              <tr><td colspan="5" class="muted">Loadingâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- ============ /ADMINS MANAGER ============ -->

  </div>

  <global-footer></global-footer>

  <script>
    async function fetchJSON(url, opts = {}) {
      const res = await fetch(url, { credentials: 'include', ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso || '-'; }
    }

    function rowHTML(a) {
      const name = a.global_name || a.username || '(unknown)';
      const avatarUrl = a.avatar
          ? `https://cdn.discordapp.com/avatars/${a.user_id}/${a.avatar}.png?size=64`
          : '/icons/WebsiteLogo.ico';
      return `
        <tr data-user-id="${a.user_id}">
          <td>
            <div class="row" style="gap:.5rem">
              <img class="avatar" src="${avatarUrl}" alt="">
              <div>
                <div>${name}</div>
                <div class="muted">@${a.username || 'â€”'}</div>
              </div>
            </div>
          </td>
          <td><span class="pill">${a.user_id}</span></td>
          <td><span class="pill">${a.added_by || 'â€”'}</span></td>
          <td>${fmtDate(a.added_at)}</td>
          <td class="right">
            <button class="invite btn-remove" data-id="${a.user_id}">Remove</button>
          </td>
        </tr>`;
    }

    async function loadAdmins() {
      const tbody = document.getElementById('admins-tbody');
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Loadingâ€¦</td></tr>`;
      try {
        const list = await fetchJSON('/admin/list'); // GET
        if (!list.length) {
          tbody.innerHTML = `<tr><td colspan="5" class="muted">No admins yet.</td></tr>`;
          return;
        }
        tbody.innerHTML = list.map(rowHTML).join('');
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Failed to load admins.</td></tr>`;
        console.error(e);
      }
    }

    async function addAdmin(id) {
      await fetchJSON('/admin/add', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ user_id: id })
      });
    }

    async function removeAdmin(id) {
      await fetchJSON('/admin/remove', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ user_id: id })
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const gate = document.getElementById('admin-gate');
      const loginNeeded = document.getElementById('admin-login-needed');
      const goLogin = document.getElementById('go-login');
      const mgr = document.getElementById('admins-manager');

      // Auth gate via /me (includes is_admin)
      try {
        const uRes = await fetch('/me', { credentials: 'include' });
        if (!uRes.ok) throw 0;
        const u = await uRes.json();
        document.getElementById('admin-name').textContent = u.global_name || u.username || 'Admin';

        if (!u.is_admin) { // hard-fail if not admin
          loginNeeded.style.display = '';
          loginNeeded.querySelector('h1').textContent = 'Access Denied';
          loginNeeded.querySelector('.about-me').textContent = 'This page is for site admins only.';
          return;
        }

        gate.style.display = '';
        mgr.style.display = '';

        // initial load
        await loadAdmins();

      } catch (e) {
        loginNeeded.style.display = '';
        if (goLogin) goLogin.addEventListener('click', () => { window.location.href = '/login'; });
        return;
      }

      // Add/Remove by input
      const input = document.getElementById('new-admin-id');
      document.getElementById('btn-add-admin').addEventListener('click', async () => {
        const id = (input.value || '').trim();
        if (!id) return alert('Enter a Discord user ID first.');
        try { await addAdmin(id); input.value=''; await loadAdmins(); }
        catch (e) { alert('Failed to add admin: ' + e.message); }
      });

      document.getElementById('btn-remove-admin').addEventListener('click', async () => {
        const id = (input.value || '').trim();
        if (!id) return alert('Enter a Discord user ID first.');
        if (!confirm('Remove this admin?')) return;
        try { await removeAdmin(id); input.value=''; await loadAdmins(); }
        catch (e) { alert('Failed to remove admin: ' + e.message); }
      });

      // Inline remove buttons
      document.getElementById('admins-tbody').addEventListener('click', async (ev) => {
        const btn = ev.target.closest('.btn-remove');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        if (!id) return;
        if (!confirm('Remove this admin?')) return;
        try { await removeAdmin(id); await loadAdmins(); }
        catch (e) { alert('Failed to remove admin: ' + e.message); }
      });

      // Refresh
      document.getElementById('btn-refresh').addEventListener('click', loadAdmins);
    });
  </script>
</body>
</html>
