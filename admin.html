<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TheTimeVortex â€” Admin</title>

  <!-- Styles & Icons -->
  <link rel="stylesheet" href="/style.css" />
  <link rel="shortcut icon" type="image/x-icon" href="/icons/WebsiteLogo.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/WebsiteLogo.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/WebsiteLogo.ico">

  <!-- OpenGraph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="TheTimeVortex â€” Admin" />
  <meta property="og:description" content="Site admin dashboard for TheTimeVortex." />
  <meta property="og:url" content="https://thetimevortex.net/admin.html" />
  <meta property="og:image" content="/icons/WebsiteLogo.ico" />

  <!-- Header/Footer & Theme -->
  <script src="/js/header-footer.js"></script>
  <script src="/js/darkmode.js" defer></script>
  <script src="/public/auth.js" defer></script>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Kodchasan:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
    rel="stylesheet">

  <!-- First-paint dark mode -->
  <script>
    (function () {
      const dm = localStorage.getItem('darkmode');
      const sys = matchMedia('(prefers-color-scheme: dark)').matches;
      if (dm === 'dark' || (dm === 'system' && sys)) {
        document.documentElement.classList.add('darkmode');
      }
    })();
  </script>

  <style>
    .row {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .text-input {
      padding: .6rem .8rem;
      border-radius: 12px;
      border: 1px solid var(--border, #4442);
      background: var(--bg, transparent);
      color: inherit;
      font: inherit;
      min-width: 260px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      padding: .6rem .5rem;
      border-bottom: 1px solid #6663;
      text-align: left;
    }

    .pill {
      padding: .2rem .55rem;
      border-radius: 999px;
      font-size: .8rem;
      opacity: .8;
      border: 1px solid #6664;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
    }

    .right {
      text-align: right;
    }

    .muted {
      opacity: .75;
      font-size: .9rem;
    }

    .card-panel {
      padding: 1.25rem;
      border-radius: 18px;
      box-shadow: 0 8px 30px #0002;
      background: var(--card, rgba(255, 255, 255, .02));
    }

    .section-gap {
      margin-top: 2.25rem;
    }
  </style>
</head>

<body>
  <global-header></global-header>

  <div class="container">
    <div class="banner-container"></div>

    <!-- Admin Gate -->
    <div class="main" id="admin-gate" style="display:none">
      <h1>Admin Dashboard</h1>
      <p>Welcome, <span id="admin-name"></span> ðŸ‘‹</p>
      <p class="about-me">Manage site roles and users below.</p>
    </div>

    <!-- Not logged-in / denied -->
    <div class="main" id="admin-login-needed" style="display:none">
      <h1>Admin Login Required</h1>
      <p class="about-me">You must be logged in with your Discord account to access admin tools.</p>
      <br />
      <button class="invite" id="go-login">Login</button>
    </div>

    <!-- ============ ADMINS MANAGER ============ -->
    <div class="discord" id="admins-manager" style="display:none">
      <h1>Admins Manager</h1>
      <p class="muted">Add/remove Discord IDs with access to this dashboard.</p>
      <br>

      <div class="card-panel">
        <div class="row">
          <input id="new-admin-id" class="text-input" type="text"
            placeholder="Discord User ID (e.g., 123456789012345678)" />
          <button class="invite" id="btn-add-admin">Add Admin</button>
          <button class="invite" id="btn-remove-admin">Remove Admin</button>
        </div>
        <p class="muted" style="margin-top:.5rem">Tip: In Discord, enable Developer Mode â†’ right-click a user â†’ Copy ID.
        </p>
      </div>

      <br><br>
      <div class="card-panel">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Current Admins</h2>
          <button class="invite" id="btn-refresh">Refresh</button>
        </div>
        <br>
        <div class="table-wrap">
          <table class="table" id="admins-table" aria-label="Admins table">
            <thead>
              <tr>
                <th>User</th>
                <th>Discord ID</th>
                <th>Added By</th>
                <th>Added At</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="admins-tbody">
              <tr>
                <td colspan="5" class="muted">Loadingâ€¦</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- ============ /ADMINS MANAGER ============ -->

    <!-- ============ USERS LIST ============ -->
    <div class="discord section-gap" id="users-list" style="display:none">
      <h1>Users</h1>
      <p class="muted">All users whoâ€™ve logged in at least once.</p>
      <br>
      <div class="card-panel">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Current Users</h2>
          <button class="invite" id="btn-users-refresh">Refresh</button>
        </div>
        <br>
        <div class="table-wrap">
          <table class="table" id="users-table" aria-label="Users table">
            <thead>
              <tr>
                <th>User</th>
                <th>Discord ID</th>
                <th>Joined</th>
              </tr>
            </thead>
            <tbody id="users-tbody">
              <tr>
                <td colspan="3" class="muted">Loadingâ€¦</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- ============ /USERS LIST ============ -->

  </div>

  <global-footer></global-footer>

  <script>
    // ---------- Helpers ----------
    async function fetchJSON(url, opts = {}) {
      const res = await fetch(url, { credentials: 'include', ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso || '-'; }
    }
    function displayName(row) {
      return row.global_name || row.username || '(unknown)';
    }
    function discordAvatarUrl(userId, avatarHash, size = 64) {
      if (avatarHash) return `https://cdn.discordapp.com/avatars/${userId}/${avatarHash}.png?size=${size}`;
      // Discord default avatars 0..5 by userId modulo
      try {
        const idx = Number(BigInt(userId) % 6n);
        return `https://cdn.discordapp.com/embed/avatars/${idx}.png`;
      } catch {
        return `https://cdn.discordapp.com/embed/avatars/0.png`;
      }
    }

    // ---------- Admins table ----------
function adminRowHTML(a) {
  const name = displayName(a);
  const avatarUrl = discordAvatarUrl(a.user_id, a.avatar, 64);
  const addedAt = a.added_at || a.created_at;

  return `
    <tr data-user-id="${a.user_id}">
      <td>
        <div class="row" style="gap:.5rem">
          <img class="avatar" src="${avatarUrl}" alt="">
          <div>
            <div>${name}</div>
            <div class="muted">${a.username ? '@' + a.username : 'â€”'}</div>
          </div>
        </div>
      </td>
      <td><span class="pill truncate">${u.user_id}</span></td>
      <td class="col-added-by"><span class="pill">${a.added_by || 'â€”'}</span></td>
      <td class="col-added-at">${fmtDate(addedAt)}</td>
      <td class="right">
        <button class="invite btn-remove" data-id="${a.user_id}">Remove</button>
      </td>
    </tr>`;
}


    async function loadAdmins() {
      const tbody = document.getElementById('admins-tbody');
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Loadingâ€¦</td></tr>`;
      try {
        const list = await fetchJSON('/admin/list'); // GET
        if (!list.length) {
          tbody.innerHTML = `<tr><td colspan="5" class="muted">No admins yet.</td></tr>`;
          return;
        }
        tbody.innerHTML = list.map(adminRowHTML).join('');
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Failed to load admins.</td></tr>`;
        console.error(e);
      }
    }

    async function addAdmin(id) {
      await fetchJSON('/admin/add', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ user_id: id })
      });
    }

    async function removeAdmin(id) {
      await fetchJSON('/admin/remove', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ user_id: id })
      });
    }



    // ---------- Users table ----------
    function userRowHTML(u) {
      const name = displayName(u);
      const avatarUrl = discordAvatarUrl(u.user_id, u.avatar, 64);
      const joined = fmtDate(u.created_at);
      const handle = u.username ? `@${u.username}` : 'â€”';
      return `
        <tr>
          <td>
            <div class="row" style="gap:.5rem">
              <img class="avatar" src="${avatarUrl}" alt="">
              <div>
                <div>${name}</div>
                <div class="muted">${handle}</div>
              </div>
            </div>
          </td>
          <td><span class="pill truncate">${u.user_id}</span></td>
          <td>${joined}</td>
        </tr>`;
    }

    async function loadUsers() {
      const tbody = document.getElementById('users-tbody');
      tbody.innerHTML = `<tr><td colspan="3" class="muted">Loadingâ€¦</td></tr>`;
      try {
        const list = await fetchJSON('/users/list'); // GET
        if (!list.length) {
          tbody.innerHTML = `<tr><td colspan="3" class="muted">No users yet.</td></tr>`;
          return;
        }
        tbody.innerHTML = list.map(userRowHTML).join('');
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="3" class="muted">Failed to load users.</td></tr>`;
        console.error(e);
      }
    }

    // ---------- Boot ----------
    document.addEventListener('DOMContentLoaded', async () => {
      const gate = document.getElementById('admin-gate');
      const loginNeeded = document.getElementById('admin-login-needed');
      const goLogin = document.getElementById('go-login');
      const adminsPanel = document.getElementById('admins-manager');
      const usersPanel = document.getElementById('users-list');

      // Auth gate via /me (expects { is_admin, username/global_name, ... })
      try {
        const uRes = await fetch('/me', { credentials: 'include' });
        if (!uRes.ok) throw 0;
        const u = await uRes.json();
        document.getElementById('admin-name').textContent = u.global_name || u.username || 'Admin';

        if (!u.is_admin) {
          loginNeeded.style.display = '';
          loginNeeded.querySelector('h1').textContent = 'Access Denied';
          loginNeeded.querySelector('.about-me').textContent = 'This page is for site admins only.';
          return;
        }

        // Show panels
        gate.style.display = '';
        adminsPanel.style.display = '';
        usersPanel.style.display = '';

        // Initial loads
        await loadAdmins();
        await loadUsers();

      } catch (e) {
        loginNeeded.style.display = '';
        if (goLogin) goLogin.addEventListener('click', () => { window.location.href = '/login'; });
        return;
      }

      // Admins actions
      const input = document.getElementById('new-admin-id');
      document.getElementById('btn-add-admin').addEventListener('click', async () => {
        const id = (input.value || '').trim();
        if (!id) return alert('Enter a Discord user ID first.');
        try { await addAdmin(id); input.value = ''; await loadAdmins(); }
        catch (e) { alert('Failed to add admin: ' + e.message); }
      });

      document.getElementById('btn-remove-admin').addEventListener('click', async () => {
        const id = (input.value || '').trim();
        if (!id) return alert('Enter a Discord user ID first.');
        if (!confirm('Remove this admin?')) return;
        try { await removeAdmin(id); input.value = ''; await loadAdmins(); }
        catch (e) { alert('Failed to remove admin: ' + e.message); }
      });

      document.getElementById('admins-tbody').addEventListener('click', async (ev) => {
        const btn = ev.target.closest('.btn-remove');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        if (!id) return;
        if (!confirm('Remove this admin?')) return;
        try { await removeAdmin(id); await loadAdmins(); }
        catch (e) { alert('Failed to remove admin: ' + e.message); }
      });

      document.getElementById('btn-refresh').addEventListener('click', loadAdmins);

      // Users actions
      document.getElementById('btn-users-refresh').addEventListener('click', loadUsers);
    });
  </script>
</body>

</html>