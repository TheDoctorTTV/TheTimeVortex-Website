<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TheTimeVortex â€” Admin</title>

  <!-- Styles & Icons -->
  <link rel="stylesheet" href="/style.css" />
  <link rel="shortcut icon" type="image/x-icon" href="/icons/WebsiteLogo.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/WebsiteLogo.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/WebsiteLogo.ico">

  <!-- OpenGraph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="TheTimeVortex â€” Admin" />
  <meta property="og:description" content="Site admin dashboard for TheTimeVortex." />
  <meta property="og:url" content="https://thetimevortex.net/admin.html" />
  <meta property="og:image" content="/icons/WebsiteLogo.ico" />

  <!-- Header/Footer & Theme -->
  <script src="/js/header-footer.js"></script>
  <script src="/js/darkmode.js" defer></script>
  <script src="/public/auth.js" defer></script>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Kodchasan:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
    rel="stylesheet">

  <!-- First-paint dark mode -->
  <script>
    (function () {
      const dm = localStorage.getItem('darkmode');
      const sys = matchMedia('(prefers-color-scheme: dark)').matches;
      if (dm === 'dark' || (dm === 'system' && sys)) {
        document.documentElement.classList.add('darkmode');
      }
    })();
  </script>

  <style>
    .row {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .text-input {
      padding: .6rem .8rem;
      border-radius: 12px;
      border: 1px solid var(--border, #4442);
      background: var(--bg, transparent);
      color: inherit;
      font: inherit;
      min-width: 260px;
    }

    .text-input[type="color"] {
      min-width: 0;
      width: 3rem;
      height: 3rem;
      padding: 0;
      cursor: pointer;
    }

    .text-input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    .text-input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 8px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      padding: .6rem .5rem;
      border-bottom: 1px solid #6663;
      text-align: left;
    }

    .pill {
      padding: .2rem .55rem;
      border-radius: 999px;
      font-size: .8rem;
      opacity: .8;
      border: 1px solid #6664;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
    }

    .right {
      text-align: right;
    }

    .muted {
      opacity: .75;
      font-size: .9rem;
    }

    .card-panel {
      padding: 1.25rem;
      border-radius: 18px;
      box-shadow: 0 8px 30px #0002;
      background: var(--card, rgba(255, 255, 255, .02));
    }

    .section-gap {
      margin-top: 2.25rem;
    }

    .table-wrap {
      width: 100%;
      overflow-x: auto;
    }
  </style>
</head>

<body>
  <global-header></global-header>

  <div class="main-container">

    <!-- Admin Gate -->
    <div class="main" id="admin-gate" style="display:none">
      <h1>Admin Dashboard</h1>
      <p>Welcome, <span id="admin-name"></span> ðŸ‘‹</p>
      <p class="about-me">Manage site roles and users below.</p>
    </div>

    <!-- Not logged-in / denied -->
    <div class="main" id="admin-login-needed" style="display:none">
      <h1>Admin Login Required</h1>
      <p class="about-me">You must be logged in with your Discord account to access admin tools.</p>
      <br />
      <button class="invite" id="go-login">Login</button>
    </div>

    <!-- ============ ADMINS MANAGER ============ -->
    <div class="admin-card" id="admins-manager" style="display:none">
      <h1>Admins Manager</h1>
      <p class="muted">Add/remove Discord IDs with access to this dashboard.</p>
      <br>

      <div class="card-panel">
        <div class="row">
          <input id="new-admin-id" class="text-input" type="text" placeholder="Discord User ID" />
          <button class="invite" id="btn-add-admin">Add Admin</button>
          <button class="invite" id="btn-remove-admin">Remove Admin</button>
        </div>
        <p class="muted" style="margin-top:.5rem">Tip: In Discord, enable Developer Mode â†’ right-click a user â†’ Copy ID.
        </p>
      </div>

      <br><br>
      <div class="card-panel">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Current Admins</h2>
          <button class="invite" id="btn-refresh">Refresh</button>
        </div>
        <br>
        <div class="table-wrap">
          <table class="table" id="admins-table" aria-label="Admins table">
            <thead>
              <tr>
                <th>User</th>
                <th>Discord ID</th>
                <th class="col-added-by">Added By</th>
                <th class="col-added-at">Added At</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="admins-tbody">
              <tr>
                <td colspan="5" class="muted">Loadingâ€¦</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- ============ /ADMINS MANAGER ============ -->

    <!-- ============ USERS LIST ============ -->
    <div class="user-card section-gap" id="users-list" style="display:none">
      <h1>Users</h1>
      <p class="muted">All users whoâ€™ve logged in at least once.</p>
      <br>
      <div class="card-panel">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Current Users</h2>
          <button class="invite" id="btn-users-refresh">Refresh</button>
        </div>
        <br>
        <div class="table-wrap">
          <table class="table" id="users-table" aria-label="Users table">
            <thead>
              <tr>
                <th>User</th>
                <th>Discord ID</th>
                <th>Joined</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="users-tbody">
              <tr>
                <td colspan="3" class="muted">Loadingâ€¦</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- ============ /USERS LIST ============ -->

    <!-- ============ BADGES MANAGER ============ -->
    <div class="user-card section-gap" id="badges-manager" style="display:none">
      <h1>Badge Manager</h1>
      <p class="muted">Manage badges and assign them to users.</p>
      <br>

      <div class="card-panel">
        <div class="row" style="flex-wrap:wrap">
          <input id="new-badge-name" class="text-input" type="text" placeholder="Name" />
          <input id="new-badge-desc" class="text-input" type="text" placeholder="Description" />
          <input id="new-badge-color" class="text-input" type="color" value="#ffffff" placeholder="color" />
          <input id="new-badge-priority" class="text-input" type="number" placeholder="Priority" />
          <input id="new-badge-role" class="text-input" type="text" placeholder="Discord Role ID" />
          <input id="new-badge-guild" class="text-input" type="text" placeholder="Discord Guild ID" />
          <label class="row" style="align-items:center;gap:.25rem">
            <input type="checkbox" id="new-badge-is-system"> System
          </label>
          <button class="invite" id="btn-create-badge">Create Badge</button>
        </div>
      </div>

      <br>

      <div class="card-panel">
        <div class="row">
          <input id="badge-user-select" class="text-input" list="badge-user-list" placeholder="Select user" />
          <datalist id="badge-user-list"></datalist>
          <input id="badge-id" class="text-input" list="badge-list" placeholder="Select badge" />
          <datalist id="badge-list"></datalist>
          <button class="invite" id="btn-assign-badge">Assign</button>
          <button class="invite" id="btn-unassign-badge">Unassign</button>
        </div>
      </div>

      <br>

      <div class="card-panel">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Current Badges</h2>
        </div>
        <br>
        <div class="table-wrap">
          <table class="table" aria-label="Badges table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Color</th>
                <th>Priority</th>
                <th>System</th>
                <th>Created</th>
                <th>Discord Role ID</th>
                <th>Discord Guild ID</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="badges-tbody">
              <tr>
                <td colspan="10" class="muted">No badges yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <br>

      <div class="card-panel">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Badge Assignments</h2>
        </div>
        <br>
        <div class="table-wrap">
          <table class="table" aria-label="Assignments table">
            <thead>
              <tr>
                <th>User</th>
                <th>Badges</th>
              </tr>
            </thead>
            <tbody id="assignments-tbody">
              <tr>
                <td colspan="2" class="muted">No assignments yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- ============ /BADGES MANAGER ============ -->

  </div>

  <global-footer></global-footer>

  <dialog id="confirm-dialog">
    <p id="confirm-message"></p>
    <div class="row" style="justify-content:flex-end;gap:.5rem;margin-top:1rem">
      <button class="invite" id="confirm-no">Cancel</button>
      <button class="invite" id="confirm-yes">OK</button>
    </div>
  </dialog>

  <dialog id="badge-edit-dialog">
    <h2>Edit Badge</h2>
    <div class="row" style="flex-wrap:wrap">
      <input id="edit-badge-color" class="text-input" type="color" />
      <input id="edit-badge-desc" class="text-input" type="text" placeholder="Description" />
      <input id="edit-badge-role" class="text-input" type="text" placeholder="Discord Role ID" />
      <input id="edit-badge-guild" class="text-input" type="text" placeholder="Discord Guild ID" />
    </div>
    <div class="row" style="justify-content:flex-end;gap:.5rem;margin-top:1rem">
      <button class="invite" id="badge-delete-btn">Delete</button>
      <button class="invite" id="badge-cancel-btn">Cancel</button>
      <button class="invite" id="badge-save-btn">Save</button>
    </div>
  </dialog>

  <script>
    // ---------- Helpers ----------
    async function fetchJSON(url, opts = {}) {
      const res = await fetch(url, { credentials: 'include', ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso || '-'; }
    }
    function displayName(row) {
      return row.global_name || row.username || '(unknown)';
    }
    function discordAvatarUrl(userId, avatarHash, size = 64) {
      if (userId && avatarHash) {
        const ext = avatarHash.startsWith('a_') ? 'gif' : 'png';
        return `https://cdn.discordapp.com/avatars/${userId}/${avatarHash}.${ext}?size=${size}`;
      }
      // Discord default avatars 0..5 by userId modulo
      try {
        const idx = BigInt(userId ?? 0n) % 5n;
        return `https://cdn.discordapp.com/embed/avatars/${idx}.png`;
      } catch {
        return `https://cdn.discordapp.com/embed/avatars/0.png`;
      }
    }

    function slugify(str) {
      return str
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function showConfirm(message) {
      return new Promise(resolve => {
        const dialog = document.getElementById('confirm-dialog');
        const msgEl = document.getElementById('confirm-message');
        const yesBtn = document.getElementById('confirm-yes');
        const noBtn = document.getElementById('confirm-no');
        msgEl.textContent = message;
        function cleanup(result) {
          yesBtn.removeEventListener('click', onYes);
          noBtn.removeEventListener('click', onNo);
          dialog.close();
          resolve(result);
        }
        function onYes() { cleanup(true); }
        function onNo() { cleanup(false); }
        yesBtn.addEventListener('click', onYes);
        noBtn.addEventListener('click', onNo);
        dialog.showModal();
      });
    }

    function openBadgeEditor(badge) {
      const dialog = document.getElementById('badge-edit-dialog');
      const colorInput = document.getElementById('edit-badge-color');
      const descInput = document.getElementById('edit-badge-desc');
      const roleInput = document.getElementById('edit-badge-role');
      const guildInput = document.getElementById('edit-badge-guild');
      const saveBtn = document.getElementById('badge-save-btn');
      const deleteBtn = document.getElementById('badge-delete-btn');
      const cancelBtn = document.getElementById('badge-cancel-btn');

      colorInput.value = badge.color || '#ffffff';
      descInput.value = badge.description || '';
      roleInput.value = badge.discord_role_id || '';
      guildInput.value = badge.discord_guild_id || '';

      dialog.showModal();

      return new Promise(resolve => {
        function cleanup(result) {
          saveBtn.removeEventListener('click', onSave);
          deleteBtn.removeEventListener('click', onDelete);
          cancelBtn.removeEventListener('click', onCancel);
          dialog.close();
          resolve(result);
        }
        function onSave() {
          cleanup({
            action: 'save',
            color: colorInput.value,
            description: descInput.value,
            discordRoleId: roleInput.value,
            discordGuildId: guildInput.value
          });
        }
        function onDelete() { cleanup({ action: 'delete' }); }
        function onCancel() { cleanup(null); }
        saveBtn.addEventListener('click', onSave);
        deleteBtn.addEventListener('click', onDelete);
        cancelBtn.addEventListener('click', onCancel);
      });
    }

    const SUPER_ADMIN_ID = '624961413500108830';

    // ---------- Admins table ----------
    function adminRowHTML(a) {
      const name = displayName(a);
      const avatarUrl = discordAvatarUrl(a.user_id, a.avatar, 64);
      const addedAt = a.added_at || a.created_at;
      const isSuper = a.user_id === SUPER_ADMIN_ID;

      return `
        <tr data-user-id="${a.user_id}">
          <td>
            <div class="row" style="gap:.5rem">
              <img class="avatar" src="${avatarUrl}" alt="">
              <div>
                <div>${name}</div>
                <div class="muted">${a.username ? '@' + a.username : 'â€”'}</div>
              </div>
            </div>
          </td>
          <td><span class="pill truncate">${a.user_id}</span></td>
          <td class="col-added-by"><span class="pill truncate">${a.added_by || 'â€”'}</span></td>
          <td class="col-added-at">${fmtDate(addedAt)}</td>
          <td class="right">
            ${isSuper ? '<span class="muted">Super Admin</span>' : `<button class="invite btn-remove" data-id="${a.user_id}">Remove</button>`}
          </td>
        </tr>`;
    }

    async function loadAdmins() {
      const tbody = document.getElementById('admins-tbody');
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Loadingâ€¦</td></tr>`;
      try {
        const list = await fetchJSON('/admin/list'); // GET
        if (!list.length) {
          tbody.innerHTML = `<tr><td colspan="5" class="muted">No admins yet.</td></tr>`;
          return;
        }
        tbody.innerHTML = list.map(adminRowHTML).join('');
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Failed to load admins.</td></tr>`;
        console.error(e);
      }
    }

    async function addAdmin(id) {
      await fetchJSON('/admin/add', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ user_id: id })
      });
    }

    async function removeAdmin(id) {
      if (id === SUPER_ADMIN_ID) throw new Error('Cannot remove the super admin.');
      await fetchJSON('/admin/remove', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ user_id: id })
      });
    }

    async function removeUser(id) {
      if (id === SUPER_ADMIN_ID) throw new Error('Cannot remove the super admin.');
      return fetchJSON('/users/remove', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ user_id: id })
      });
    }


    // ---------- Badges manager ----------
    const badges = [];
    const userBadges = {};
    const allUsers = [];
    const userMap = {};

    function renderBadges() {
      const tbody = document.getElementById('badges-tbody');
      if (!tbody) return;
      if (!badges.length) {
        tbody.innerHTML = `<tr><td colspan="10" class="muted">No badges yet.</td></tr>`;
        return;
      }
      tbody.innerHTML = badges.map(b => `
          <tr data-badge-id="${b.id}">
            <td><span class="pill">${b.id}</span></td>
            <td>${b.name}</td>
            <td>${b.description || 'â€”'}</td>
            <td>
              <span class="pill" style="background:${b.color};border-color:#6664">${b.color}</span>
            </td>
            <td>${b.priority ?? 0}</td>
            <td>${b.is_system ? 'Yes' : 'No'}</td>
            <td>${fmtDate(b.created_at)}</td>
            <td>${b.discord_role_id || 'â€”'}</td>
            <td>${b.discord_guild_id || 'â€”'}</td>
            <td class="right"><button class="invite btn-badge-edit" data-id="${b.id}">Edit</button></td>
          </tr>
        `).join('');
    }

    function renderAssignments() {
      const tbody = document.getElementById('assignments-tbody');
      if (!tbody) return;
      const entries = Object.entries(userBadges);
      if (!entries.length) {
        tbody.innerHTML = `<tr><td colspan="2" class="muted">No assignments yet.</td></tr>`;
        return;
      }
      tbody.innerHTML = entries.map(([userId, badgeSet]) => {
        const names = [...badgeSet].map(id => {
          const b = badges.find(x => x.id === id);
          return b ? b.name : id;
        }).join(', ') || 'â€”';
        const user = userMap[userId];
        const uname = user ? displayName(user) : userId;
        return `
            <tr>
              <td>${uname}</td>
              <td>${names}</td>
            </tr>
          `;
      }).join('');
    }

    async function loadBadges() {
      try {
        const list = await fetchJSON('/badges/list');
        badges.splice(0, badges.length, ...list);
        renderBadges();
        const badgeList = document.getElementById('badge-list');
        if (badgeList) {
          badgeList.innerHTML = badges
            .map(b => `<option value="${b.id}" label="${b.name}"></option>`)
            .join('');
        }
        for (const b of badges) {
          if (b.discord_role_id && b.discord_guild_id) {
            try {
              await fetchJSON('/badges/assign-role', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ badge_id: b.id })
              });
            } catch (err) { console.error(err); }
          }
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function loadAssignments() {
      try {
        const list = await fetchJSON('/badges/assignments');
        for (const k in userBadges) delete userBadges[k];
        for (const row of list) {
          userBadges[row.user_id] = new Set(row.badges);
        }
        renderAssignments();
      } catch (e) {
        console.error(e);
      }
    }

    // ---------- Users table ----------
    function userRowHTML(u) {
      const name = displayName(u);
      const avatarUrl = discordAvatarUrl(u.user_id, u.avatar, 64);
      const joined = fmtDate(u.created_at);
      const handle = u.username ? `@${u.username}` : 'â€”';
      const isSuper = u.user_id === SUPER_ADMIN_ID;
      return `
        <tr>
          <td>
            <div class="row" style="gap:.5rem">
              <img class="avatar" src="${avatarUrl}" alt="">
              <div>
                <div>${name}</div>
                <div class="muted">${handle}</div>
              </div>
            </div>
          </td>
          <td><span class="pill truncate">${u.user_id}</span></td>
          <td>${joined}</td>
          <td class="right">
            ${isSuper ? '<span class="muted">Super Admin</span>' : `<button class="invite btn-user-remove" data-id="${u.user_id}">Remove</button>`}
          </td>
        </tr>`;
    }

    async function loadUsers() {
      const tbody = document.getElementById('users-tbody');
      tbody.innerHTML = `<tr><td colspan="3" class="muted">Loadingâ€¦</td></tr>`;
      try {
        const list = await fetchJSON('/users/list'); // GET
        allUsers.splice(0, allUsers.length, ...list);
        for (const u of list) userMap[u.user_id] = u;
        populateUserSelect();
        if (!list.length) {
          tbody.innerHTML = `<tr><td colspan="3" class="muted">No users yet.</td></tr>`;
          return;
        }
        tbody.innerHTML = list.map(userRowHTML).join('');
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="3" class="muted">Failed to load users.</td></tr>`;
        console.error(e);
      }
    }

    function populateUserSelect() {
      const list = document.getElementById('badge-user-list');
      if (!list) return;
      list.innerHTML = allUsers
        .map(u => `<option value="${u.user_id}" label="${displayName(u)}"></option>`)
        .join('');
    }

    // ---------- Boot ----------
    document.addEventListener('DOMContentLoaded', async () => {
      const gate = document.getElementById('admin-gate');
      const loginNeeded = document.getElementById('admin-login-needed');
      const goLogin = document.getElementById('go-login');
      const adminsPanel = document.getElementById('admins-manager');
      const usersPanel = document.getElementById('users-list');
      const badgesPanel = document.getElementById('badges-manager');

      // Auth gate via /me (expects { is_admin, username/global_name, ... })
      try {
        const uRes = await fetch('/me', { credentials: 'include' });
        if (!uRes.ok) throw 0;
        const u = await uRes.json();
        document.getElementById('admin-name').textContent = u.global_name || u.username || 'Admin';

        if (!u.is_admin) {
          loginNeeded.style.display = '';
          loginNeeded.querySelector('h1').textContent = 'Access Denied';
          loginNeeded.querySelector('.about-me').textContent = 'This page is for site admins only.';
          return;
        }

        // Show panels
        gate.style.display = '';
        adminsPanel.style.display = '';
        usersPanel.style.display = '';
        badgesPanel.style.display = '';

        // Initial loads
        await Promise.all([loadAdmins(), loadUsers()]);
        await loadBadges();
        await loadAssignments();

      } catch (e) {
        loginNeeded.style.display = '';
        if (goLogin) goLogin.addEventListener('click', () => { window.location.href = '/login'; });
        return;
      }

      // Admins actions
      const input = document.getElementById('new-admin-id');
      document.getElementById('btn-add-admin').addEventListener('click', async () => {
        const id = (input.value || '').trim();
        if (!id) return alert('Enter a Discord user ID first.');
        try { await addAdmin(id); input.value = ''; await loadAdmins(); }
        catch (e) { alert('Failed to add admin: ' + e.message); }
      });

      document.getElementById('btn-remove-admin').addEventListener('click', async () => {
        const id = (input.value || '').trim();
        if (!id) return alert('Enter a Discord user ID first.');
        if (id === SUPER_ADMIN_ID) return alert('Cannot remove the super admin.');
        if (!(await showConfirm('Remove this admin?'))) return;
        try { await removeAdmin(id); input.value = ''; await loadAdmins(); }
        catch (e) { alert('Failed to remove admin: ' + e.message); }
      });

      document.getElementById('admins-tbody').addEventListener('click', async (ev) => {
        const btn = ev.target.closest('.btn-remove');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        if (!id) return;
        if (id === SUPER_ADMIN_ID) return alert('Cannot remove the super admin.');
        if (!(await showConfirm('Remove this admin?'))) return;
        try { await removeAdmin(id); await loadAdmins(); }
        catch (e) { alert('Failed to remove admin: ' + e.message); }
      });

      document.getElementById('btn-refresh').addEventListener('click', loadAdmins);

      // Users actions
      document.getElementById('btn-users-refresh').addEventListener('click', loadUsers);

      document.getElementById('users-tbody').addEventListener('click', async (ev) => {
        const btn = ev.target.closest('.btn-user-remove');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        if (!id) return;
        if (id === SUPER_ADMIN_ID) return alert('Cannot remove the super admin.');
        if (!(await showConfirm('Remove this user from the site database? (Any admin role will also be removed)'))) return;
        try {
          await removeUser(id);
          await Promise.all([loadUsers(), loadAdmins()]); // refresh both lists
        } catch (e) {
          alert('Failed to remove user: ' + e.message);
        }
      });

      // Badges actions
      document.getElementById('btn-create-badge').addEventListener('click', async () => {
        const nameInput = document.getElementById('new-badge-name');
        const descInput = document.getElementById('new-badge-desc');
        const colorInput = document.getElementById('new-badge-color');
        const prioInput = document.getElementById('new-badge-priority');
        const roleInput = document.getElementById('new-badge-role');
        const guildInput = document.getElementById('new-badge-guild');
        const sysInput = document.getElementById('new-badge-is-system');

        const name = (nameInput.value || '').trim();
        const id = slugify(name);
        const description = (descInput.value || '').trim();
        const color = colorInput.value || '#ffffff';
        const priority = Number(prioInput.value) || 0;
        const discordRoleId = (roleInput.value || '').trim();
        const discordGuildId = (guildInput.value || '').trim();
        const isSystem = sysInput.checked;
        if (!name) return alert('Enter name.');

        try {
          await fetchJSON('/badges/create', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({
              id,
              name,
              description,
              color,
              priority,
              is_system: isSystem,
              discord_role_id: discordRoleId,
              discord_guild_id: discordGuildId
            })
          });
          await loadBadges();
          await loadAssignments();
        } catch (e) {
          return alert('Failed to create badge: ' + e.message);
        }

        nameInput.value = '';
        descInput.value = '';
        colorInput.value = '#ffffff';
        prioInput.value = '';
        roleInput.value = '';
        guildInput.value = '';
        sysInput.checked = false;
      });
      document.getElementById('badges-tbody').addEventListener('click', async (ev) => {
        const btn = ev.target.closest('.btn-badge-edit');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        if (!id) return;
        const b = badges.find(x => x.id === id);
        if (!b) return;

        const res = await openBadgeEditor(b);
        if (!res) return;

        if (res.action === 'delete') {
          try {
            await fetchJSON('/badges/remove', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ id })
            });
            await loadBadges();
            await loadAssignments();
          } catch (e) {
            alert('Failed to delete badge: ' + e.message);
          }
          return;
        }

        const { color, description, discordRoleId, discordGuildId } = res;
        try {
          await fetchJSON('/badges/update', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({
              id,
              description,
              color,
              discord_role_id: discordRoleId || null,
              discord_guild_id: discordGuildId || null
            })
          });
          await loadBadges();
          await loadAssignments();
        } catch (e) {
          alert('Failed to update badge: ' + e.message);
        }
      });

      const userSelect = document.getElementById('badge-user-select');
      const badgeInput = document.getElementById('badge-id');

      document.getElementById('btn-assign-badge').addEventListener('click', async () => {
        const uid = (userSelect.value || '').trim();
        const bids = (badgeInput.value || '').trim().split(/[\s,]+/).filter(Boolean);
        if (!uid || !bids.length) return alert('Select a user and badge(s).');
        try {
          await fetchJSON('/badges/assign', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ user_id: uid, badge_ids: bids })
          });
          await loadAssignments();
          userSelect.value = '';
          badgeInput.value = '';
        } catch (e) {
          alert('Failed to assign badge: ' + e.message);
        }
      });

      document.getElementById('btn-unassign-badge').addEventListener('click', async () => {
        const uid = (userSelect.value || '').trim();
        const bids = (badgeInput.value || '').trim().split(/[\s,]+/).filter(Boolean);
        if (!uid || !bids.length) return alert('Select a user and badge(s).');
        try {
          await fetchJSON('/badges/unassign', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ user_id: uid, badge_ids: bids })
          });
          await loadAssignments();
          userSelect.value = '';
          badgeInput.value = '';
        } catch (e) {
          alert('Failed to unassign badge: ' + e.message);
        }
      });

    });
  </script>
</body>

</html>